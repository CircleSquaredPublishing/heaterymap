<?php date_default_timezone_set('America/New_York');$today=date('l, F jS');if($_POST){$data_arr=geocode($_POST['address']);if($data_arr){$latitude=$data_arr[0];$longitude=$data_arr[1];$city=$data_arr[2];echo "<div class='col-md-12'>The Heatery Top Ten within 10 km of $city on this Beautiful $today.</div></div>";}else{}};function geocode($address){$address=urlencode($address);$url="http://maps.google.com/maps/api/geocode/json?sensor=false&address={$address}";$resp_json=file_get_contents($url);$resp=json_decode($resp_json,true);if($resp['status']='OK'){$lati=$resp['results'][0]['geometry']['location']['lat'];$longi=$resp['results'][0]['geometry']['location']['lng'];$city=$resp['results']['0']['address_components']['0']['long_name'];if($lati&&$longi&&$city){$data_arr=array();array_push($data_arr,$lati,$longi,$city);return $data_arr;}else{return false;}}else{return false;}};?><?php $table=basename(__FILE__,'.php');$name=($table.'.json');$fp=fopen($name,'w');$ch=curl_init();curl_setopt($ch,CURLOPT_URL,'https://graph.facebook.com/v2.4/search?q=restaurant&type=place&distance=8000&center='.$latitude.','.$longitude.'&fields=location,name,likes,talking_about_count,were_here_count,description,website&limit=250&access_token=1452021355091002|x-ZB0iKqWQmYqnJQ-wXoUjl-XtY');curl_setopt($ch,CURLOPT_FILE,$fp);curl_exec($ch);curl_close($ch);$results=file_get_contents($name);$fb_array=json_decode($results,true);foreach($fb_array[data] as $i){json_decode($i,true);echo PHP_EOL;$stmt1=$conn->prepare("INSERT INTO top10_markers(FID, fb_web,fb_description,fb_name, fb_likes, fb_were_here, fb_talking_about, fb_street, fb_city, fb_state, fb_zip, fb_lat, fb_lng)VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");$stmt1-> bind_param("dsssiiisssidd",$FID,$fb_web,$fb_description,$fb_name,$fb_likes,$fb_were_here,$fb_talking_about,$fb_street,$fb_city,$fb_state,$fb_zip,$fb_lat,$fb_lng);$FID=mysqli_real_escape_string($conn,$i['id']);$fb_web=mysqli_real_escape_string($conn,$i['website']);$fb_description=mysqli_real_escape_string($conn,$i['description']);$fb_name=mysqli_real_escape_string($conn,$i['name']);$fb_likes=mysqli_real_escape_string($conn,$i['likes']);$fb_were_here=mysqli_real_escape_string($conn,$i['were_here_count']);$fb_talking_about=mysqli_real_escape_string($conn,$i['talking_about_count']);$fb_street=mysqli_real_escape_string($conn,$i['location']['street']);$fb_city=mysqli_real_escape_string($conn,$i['location']['city']);$fb_state=mysqli_real_escape_string($conn,$i['location']['state']);$fb_zip=mysqli_real_escape_string($conn,$i['location']['zip']);$fb_lat=mysqli_real_escape_string($conn,$i['location']['latitude']);$fb_lng=mysqli_real_escape_string($conn,$i['location']['longitude']);$stmt1->execute();}$stmt1->close();?> <?php echo "<div class='table-responsive'><table class='table-bordered table-hover'>";echo "<thead><tr><th>Establishment</th><th>Talking About</th><th>Were Here</th><th>Likes</th><th>Miles from City Center</th></tr></thead><tbody>";class TableRows extends RecursiveIteratorIterator{function __construct($it){parent::__construct($it,self::LEAVES_ONLY);}function current(){return "<td>".parent::current()."</td>";}function beginChildren(){echo "<tr>";}function endChildren(){echo "</tr>"."\n";}}try{$conn2=new PDO("mysql:host=$servername; dbname=$dbname",$username,$password);$conn2->setAttribute(PDO::ATTR_ERRMODE,PDO::ERRMODE_EXCEPTION);date_default_timezone_set("America/New_York");$stmt2=$conn2->query("SELECT fb_name,FORMAT(fb_talking_about,0),FORMAT(fb_were_here,0),FORMAT(fb_likes,0),
TRUNCATE((SQRT(POW(69.1*(fb_lat-$latitude),2)+POW(69.1*($longitude-fb_lng)*COS(fb_lat/57.3),2))*0.621371),2)AS distance FROM top10_markers WHERE fb_date=CURDATE() HAVING distance<10 ORDER BY fb_talking_about DESC LIMIT 10");$stmt2->execute();$result=$stmt2->setFetchMode(PDO::FETCH_ASSOC);foreach(new TableRows(new RecursiveArrayIterator($stmt2->fetchAll()))as $k=>$v){echo stripslashes($v);}}catch(PDOException $e){}echo "</tbody></table></div></div>";$conn2=null;?>
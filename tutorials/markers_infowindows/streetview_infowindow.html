<!DOCTYPE html>
<html>
<title>STREET VIEW INFOWINDOWS</title>
<meta charset= "UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<head>
<!----------EXTERNAL LIBRARIES, SCRIPTS & STYLESHEETS---------->   
<link rel="stylesheet" href="/github/geocodedmap-master/css/style.css" />

<link rel="stylesheet" type="text/css" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css" />

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=false&libraries=visualization,places">
</script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>

<script src="/github/geocodedmap-master/js/custom_style.js"></script>
    <script src="downloadxml.js"></script>
<link rel="stylesheet" href="/github/geocodedmap-master/css/style.css"/>
 
<script>
// this variable will collect the html which will eventually be placed in the side_bar 
        var side_bar_html = "";

// arrays to hold copies of the markers used by the side_bar 
        var gmarkers = [];

// global "map" variable
        var map = null;

        var sv = new google.maps.StreetViewService();
        
        var clickedMarker = null;
        
        var panorama = null;

// Create the shared infowindow with three DIV placeholders
// One for a text string, oned for the html content from the xml, one for the StreetView panorama.
        var content = document.createElement("DIV");
        
        
        var title = document.createElement("DIV");
        content.appendChild(title);
        
        
        var streetview = document.createElement("DIV");
        streetview.style.width = "400px";
        streetview.style.height = "300px";
        content.appendChild(streetview);
        
        
        var htmlContent = document.createElement("DIV");
        content.appendChild(htmlContent);
        
        
        var infowindow = new google.maps.InfoWindow({
            size: new google.maps.Size(150, 50),
            content: content
            });
        
        
// A function to create the marker and set up the event window function 
        function createMarker(latlng, name, html) {
            var contentString = html;
            var marker = new google.maps.Marker({
                position: latlng,
                map: map,
                title: name,
                zIndex: Math.round(latlng.lat() * -100000) << 5
                });
                marker.myHtml = html;

    
// openInfoWindow(marker);
google.maps.event.addListener(marker, "click", function() {
        clickedMarker = marker;
        sv.getPanoramaByLocation(marker.getPosition(), 50, processSVData);
        });
            
            
// save the info we need to use later for the side_bar
    gmarkers.push(marker);
            
            
// add a line to the side_bar html
            
            
side_bar_html += '<a href="javascript:myclick(' + (gmarkers.length - 1) + ')">' + name + '<\/a><br>';
        }

// This function picks up the click and opens the corresponding info window
        function myclick(i) {
            google.maps.event.trigger(gmarkers[i], "click");
            }

        function processSVData(data, status) {
            if (status == google.maps.StreetViewStatus.OK) {
                var marker = clickedMarker;
                openInfoWindow(clickedMarker);

                if (!!panorama && !!panorama.setPano) {

                    panorama.setPano(data.location.pano);
                    panorama.setPov({
                        heading: 270,
                        pitch: 0,
                        zoom: 1
                    });
                    panorama.setVisible(true);

                    google.maps.event.addListener(marker, 'click', function() {

                        var markerPanoID = data.location.pano;
                        
// Set the Pano to use the passed panoID
                        panorama.setPano(markerPanoID);
                        panorama.setPov({
                            heading: 270,
                            pitch: 0,
                            zoom: 1
                        });
                        panorama.setVisible(true);
                    });
                }
            } else {
                
                openInfoWindow(clickedMarker);
                title.innerHTML = clickedMarker.getTitle() + "<br>Street View data not found for this location";
                htmlContent.innerHTML = clickedMarker.myHtml;
                panorama.setVisible(false);
                }
            }
        
        
// Create the map. No need to specify zoom and center as we fit the map further down.
        function initialize() {
            map = new google.maps.Map(document.getElementById("map-canvas"), {
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                streetViewControl: false
                });


            google.maps.event.addListener(map, 'click', function() {
                infowindow.close();
            });
            
            
// Read the data from example.xml
            downloadUrl("example.xml", function(doc) {
                var xmlDoc = xmlParse(doc);
                var markers = xmlDoc.documentElement.getElementsByTagName("marker");
                var bounds = new google.maps.LatLngBounds();
                for (var i = 0; i < markers.length; i++) {
                    // obtain the attribues of each marker
                    var lat = parseFloat(markers[i].getAttribute("lat"));
                    var lng = parseFloat(markers[i].getAttribute("lng"));
                    var point = new google.maps.LatLng(lat, lng);
                    var html = markers[i].getAttribute("html");
                    var label = markers[i].getAttribute("label");
                    // create the marker
                    var marker = createMarker(point, label, html);
                    bounds.extend(point);

                }
                
// put the assembled side_bar_html contents into the side_bar div
                document.getElementById("side_bar").innerHTML = side_bar_html;
                
// Zoom and center the map to fit the markers
                map.fitBounds(bounds);
            });
        }


// Handle the DOM ready event to create the StreetView panorama
// as it can only be created once the DIV inside the infowindow is loaded in the DOM.
        
        var pin = new google.maps.MVCObject();
        google.maps.event.addListenerOnce(infowindow, "domready", function() {
            panorama = new google.maps.StreetViewPanorama(streetview, {
                navigationControl: false,
                enableCloseButton: false,
                addressControl: false,
                linksControl: false,
                visible: true
            });
            panorama.bindTo("position", pin);
        });

// Set the infowindow content and display it on marker click. Use a 'pin' MVCObject as the order of the domready and marker click events is not garanteed.
        function openInfoWindow(marker) {
            title.innerHTML = marker.getTitle();
            htmlContent.innerHTML = marker.myHtml;
            pin.set("position", marker.getPosition());
            infowindow.open(map, marker);
        }
    </script>
    
</head>

<body style="background-color: #000;" onload="initialize()">

<nav class="navbar navbar-inverse">

<div class="container-fluid">

<div class="navbar-header">

  <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">

    <span class="icon-bar"></span>

    <span class="icon-bar"></span>

    <span class="icon-bar"></span>  

  </button><!--@end .navbar-toggle-->

  <a class="navbar-brand" href="http://www.heatery.io">heatery.io</a>

</div><!--@end .navbar-header-->

<div class="collapse navbar-collapse" id="myNavbar">

  <ul class="nav navbar-nav navbar-right">

    <li><a href="#"><span class="glyphicon glyphicon-user"></span>Client Portal</a></li>

    <li><a href="#"><span class="glyphicon glyphicon-log-in"></span>The Speak Easy</a></li>

  </ul><!--@end .nav navbar-nav navbar-right-->

</div><!--@end .collapse navbar-collapse-->

</div><!--@end .container-fluid-->

</nav><!--@end .navbar navbar-inverse-->

<div id="map-canvas"></div>

<div id="side_bar"></div>

</body>

</html>